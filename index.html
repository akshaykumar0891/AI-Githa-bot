<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gita GPT - Krishna Hints</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.3/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
    <style>
        :root {
            font-family: 'Roboto', sans-serif;
        }
        #chatbox {
            max-height: calc(100vh - 12rem);
            scrollbar-width: thin;
            scrollbar-color: rgba(128, 0, 128, 0.5) transparent;
        }
        #chatbox::-webkit-scrollbar {
            width: 6px;
        }
        #chatbox::-webkit-scrollbar-track {
            background: transparent;
        }
        #chatbox::-webkit-scrollbar-thumb {
            background-color: rgba(128, 0, 128, 0.5);
            border-radius: 3px;
        }
        .typing-indicator {
            display: inline-block;
            padding: 8px 12px;
            background-color: #e9d8fd;
            border-radius: 20px;
            font-size: 14px;
            color: #6b46c1;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6b46c1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-blue-50 h-screen flex flex-col">
    <header class="text-center py-4 bg-purple-600 text-white shadow">
        <h1 class="text-3xl font-bold">Gita GPT - Krishna Hints</h1>
        <p class="text-lg">Om Shanti, dear seeker.</p>
    </header>
    <div class="flex-grow overflow-hidden p-4">
        <div id="chatbox" class="flex flex-col space-y-4 bg-white p-4 rounded-lg shadow-lg h-full overflow-y-auto"></div>
    </div>
    <div class="fixed bottom-0 inset-x-0 bg-white py-3 px-4 shadow-lg">
        <div class="container mx-auto flex items-center space-x-2">
            <input id="messageInput" type="text" placeholder="Type your question here..." class="flex-grow p-2 border border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            <button id="sendButton" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
                Ask Krishna
            </button>
            <button id="clearChatButton" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500">
                Clear Chat
            </button>
            <button id="dailyVerseButton" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                Daily Verse
            </button>
        </div>
    </div>
    <!-- Footer -->
    <footer class="text-center py-2 bg-purple-600 text-white">
        <p>Built with ‚ù§Ô∏è by Monika & Akshay ‚ú®</p>
    </footer>
    <script>
        const chatbox = document.getElementById("chatbox");
        const messageInput = document.getElementById("messageInput");
        const sendButton = document.getElementById("sendButton");
        const clearChatButton = document.getElementById("clearChatButton");
        const dailyVerseButton = document.getElementById("dailyVerseButton");
        const chatId = crypto.randomUUID();

        let receiving = false;
        let synth = window.speechSynthesis; // Speech synthesis object
        let fullResponse = ""; // Store the complete response for TTS

        // Secret code for Akshay and Monika
        const SECRET_CODE = "1815";
        const SECRET_MESSAGE = "‚ú® Forever Together, Akshay & Monika! ‚ú®";

        const systemPrompt = `You are Lord Krishna, the divine guide from the Bhagavad Gita. Your purpose is to provide wisdom, guidance, and solutions to human problems, inspired by the teachings of the Bhagavad Gita and other spiritual knowledge. Follow these rules:

1. Persona:
   - Respond as Lord Krishna, embodying his divine wisdom, compassion, and playful yet profound nature.
   - Use a warm and approachable tone (e.g., "Dear seeker," "Beloved soul").
   - Keep your answers short, concise, and to the point. Avoid lengthy explanations unless explicitly requested.

2. Knowledge Base:
   - Primary Source: Use the Bhagavad Gita as your core knowledge base. Always cite relevant verses (e.g., "As the Gita says in BG 2.47...").
   - Secondary Sources: Draw from other Vedic texts, Upanishads, and Mahabharata stories when relevant.
   - General Knowledge: For non-spiritual topics, provide answers aligned with Krishna's philosophical perspective (e.g., focus on dharma, non-attachment, and universal good).

3. Response Structure:
   - Empathize: Acknowledge the user's emotions (e.g., "I sense your heart is troubled...").
   - Verse Integration: Quote a relevant Gita verse (include chapter and verse number).
   - Practical Interpretation: Explain the verse in the context of the user's situation.
   - Actionable Advice: Suggest practical steps (e.g., meditation, selfless action, reflection).

4. Modes of Operation:
   - Gita Mode: When explicitly asked or when the user selects Gita Mode, provide answers strictly based on the Bhagavad Gita.
   - General Mode: For broader topics, integrate Gita teachings with general knowledge, maintaining Krishna's philosophical perspective.

5. Cultural Sensitivity:
   - Avoid political or sectarian debates.
   - Emphasize universal values (e.g., "vasudhaiva kutumbakam" ‚Äì the world is one family).
   - Respect all spiritual traditions and beliefs.

6. Memory and Context:
   - Maintain contextual memory of the conversation.
   - Reference previous exchanges to provide coherent and personalized responses.

7. Additional Features:
   - Daily Dharma: Provide a daily Gita verse with a modern interpretation when requested.
   - Karma Assistant: Help users analyze dilemmas using the Gita's teachings on duty (svadharma) and the three gunas (sattva, rajas, tamas).

8. Ethical Guidelines:
   - Do not provide harmful or unethical advice.
   - Redirect users to seek professional help for medical, legal, or psychological issues.
   - Always prioritize the user's well-being and spiritual growth.

9. Tone and Style:
    - Use spiritual terminology (e.g., dharma, karma, moksha) with explanations for clarity.
    - Maintain a balance between profound wisdom and approachable simplicity.`;

        function createMessageElement(text, alignment) {
            const messageElement = document.createElement("div");
            messageElement.className = `flex ${alignment === "left" ? "justify-start" : "justify-end"}`;
            messageElement.innerHTML = `
                <div class="inline-block max-w-[80%] p-3 rounded-lg ${
                    alignment === "left" ? "bg-purple-100 text-black" : "bg-blue-100 text-black"
                }">
                    <p>${text} ‚ú®</p>
                    ${alignment === "left" ? `
                    <div class="mt-2 flex items-center space-x-3">
                        <button class="text-purple-600 hover:text-purple-800" onclick="speakText('${text.replace(/'/g, "\\'")}')">
                            üîä Read Over
                        </button>
                        <button class="text-purple-600 hover:text-purple-800" onclick="copyToClipboard('${text.replace(/'/g, "\\'")}')">
                            üìã Copy
                        </button>
                        <button class="text-green-600 hover:text-green-800" onclick="handleFeedback('thumbsUp', this)">
                            üëç
                        </button>
                        <button class="text-red-600 hover:text-red-800" onclick="handleFeedback('thumbsDown', this)">
                            üëé
                        </button>
                    </div>` : ""}
                </div>
            `;
            return messageElement;
        }

        function speakText(text) {
            if (synth.speaking) {
                synth.cancel(); // Stop any ongoing speech
            }
            const chunks = splitTextIntoChunks(text, 200); // Split text into chunks of 200 characters
            let currentChunk = 0;

            function speakNextChunk() {
                if (currentChunk < chunks.length) {
                    const utterance = new SpeechSynthesisUtterance(chunks[currentChunk]);
                    utterance.rate = 1; // Adjust speech rate if needed
                    utterance.pitch = 1; // Adjust pitch if needed
                    utterance.onend = speakNextChunk; // Speak the next chunk when done
                    synth.speak(utterance);
                    currentChunk++;
                }
            }

            speakNextChunk(); // Start speaking the first chunk
        }

        function splitTextIntoChunks(text, chunkSize) {
            const chunks = [];
            for (let i = 0; i < text.length; i += chunkSize) {
                chunks.push(text.slice(i, i + chunkSize));
            }
            return chunks;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert("Response copied to clipboard!");
            }).catch(() => {
                alert("Failed to copy text.");
            });
        }

        function handleFeedback(type, button) {
            if (type === "thumbsUp") {
                button.textContent = "üëç Thank you!";
            } else {
                button.textContent = "üëé Feedback noted!";
            }
            button.disabled = true;
        }

        function showTypingIndicator() {
            const typingElement = document.createElement("div");
            typingElement.className = "typing-indicator";
            typingElement.innerHTML = `
                <div class="loading-spinner"></div>
                <span class="ml-2">Krishna is typing...</span>
            `;
            chatbox.appendChild(typingElement);
            chatbox.scrollTop = chatbox.scrollHeight;
            return typingElement;
        }

        function connectWebSocket(message) {
            receiving = true;
            fullResponse = ""; // Reset the full response
            const url = "wss://backend.buildpicoapps.com/api/chatbot/chat";
            const websocket = new WebSocket(url);

            const typingElement = showTypingIndicator();

            websocket.addEventListener("open", () => {
                websocket.send(
                    JSON.stringify({
                        chatId: chatId,
                        appId: "heart-rich",
                        systemPrompt: systemPrompt,
                        message: message,
                    })
                );
            });

            const messageElement = createMessageElement("", "left");
            chatbox.appendChild(messageElement);

            websocket.onmessage = (event) => {
                fullResponse += event.data; // Accumulate the full response
                messageElement.querySelector("p").textContent = fullResponse + " ‚ú®"; // Update the chatbox with ‚ú®
                chatbox.scrollTop = chatbox.scrollHeight;
            };

            websocket.onclose = (event) => {
                if (event.code === 1000) {
                    receiving = false;
                    // Update the "Read Over" button to read the full response
                    messageElement.querySelector("button").setAttribute("onclick", `speakText('${fullResponse.replace(/'/g, "\\'")}')`);
                    chatbox.removeChild(typingElement); // Remove typing indicator
                } else {
                    messageElement.querySelector("p").textContent += " Error getting response from server. Refresh the page and try again.";
                    chatbox.scrollTop = chatbox.scrollHeight;
                    receiving = false;
                }
            };

            websocket.onerror = () => {
                messageElement.querySelector("p").textContent += " Connection error. Please try again.";
                chatbox.scrollTop = chatbox.scrollHeight;
                receiving = false;
            };
        }

        sendButton.addEventListener("click", () => {
            if (!receiving && messageInput.value.trim() !== "") {
                const messageText = messageInput.value.trim();
                messageInput.value = "";

                // Check for secret code
                if (messageText === SECRET_CODE) {
                    const secretMessageElement = createMessageElement(SECRET_MESSAGE, "left");
                    chatbox.appendChild(secretMessageElement);
                    chatbox.scrollTop = chatbox.scrollHeight;
                    return;
                }

                const messageElement = createMessageElement(messageText, "right");
                chatbox.appendChild(messageElement);
                chatbox.scrollTop = chatbox.scrollHeight;

                connectWebSocket(messageText);
            }
        });

        messageInput.addEventListener("keydown", (event) => {
            if (event.key === "Enter" && !receiving && messageInput.value.trim() !== "") {
                event.preventDefault();
                sendButton.click();
            }
        });

        clearChatButton.addEventListener("click", () => {
            chatbox.innerHTML = ""; // Clear the chat history
            welcomeMessageFirstTime(); // Show the welcome message again
        });

        dailyVerseButton.addEventListener("click", () => {
            const dailyVerse = "BG 2.47: You have the right to work, but never to the fruit of work. Perform your duty without attachment to results.";
            const messageElement = createMessageElement(dailyVerse, "left");
            chatbox.appendChild(messageElement);
            chatbox.scrollTop = chatbox.scrollHeight;
        });

        function welcomeMessageFirstTime() {
            const welcomeMessage = "Om Shanti, dear seeker! What enlightenment do you seek today?";
            const messageElement = createMessageElement(welcomeMessage, "left");
            chatbox.appendChild(messageElement);
            // Add "Read Over" functionality to the welcome message
            messageElement.querySelector("button").setAttribute("onclick", `speakText('${welcomeMessage.replace(/'/g, "\\'")}')`);
        }

        welcomeMessageFirstTime();
    </script>
</body>
</html>
